使用设备: cuda
=== 加载数据 ===
HLA-pep 数据: 5396112
TCR-pep 数据: 1622176
TCR-HLA-pep 三元组数据: 183890
=== 构建全局映射 ===
肽数量: 1344129, TCR数量: 256136, HLA数量: 227
=== 第一阶段：HLA-peptide关系预训练 ===
=== 预训练 KGAN（hla_pep 关系学习） ===
正样本: 2698056, 负样本: 2698056, 总计: 5396112
HLA_PEP PreTrain Epoch 1/10  loss=0.4249  acc=0.8151
  HLA_PEP 评估指标:
  Accuracy:  0.8151
  Precision: 0.7766
  Recall:    0.8848
  F1-Score:  0.8272
  AUC-ROC:   0.8898
  AUC-PR:    0.8731
HLA_PEP PreTrain Epoch 2/10  loss=0.3826  acc=0.8355
  HLA_PEP 评估指标:
  Accuracy:  0.8355
  Precision: 0.8021
  Recall:    0.8908
  F1-Score:  0.8442
  AUC-ROC:   0.9171
  AUC-PR:    0.9090
HLA_PEP PreTrain Epoch 3/10  loss=0.3598  acc=0.8490
  HLA_PEP 评估指标:
  Accuracy:  0.8490
  Precision: 0.8216
  Recall:    0.8916
  F1-Score:  0.8552
  AUC-ROC:   0.9309
  AUC-PR:    0.9245
HLA_PEP PreTrain Epoch 4/10  loss=0.3400  acc=0.8629
  HLA_PEP 评估指标:
  Accuracy:  0.8629
  Precision: 0.8438
  Recall:    0.8906
  F1-Score:  0.8666
  AUC-ROC:   0.9411
  AUC-PR:    0.9355
HLA_PEP PreTrain Epoch 5/10  loss=0.3251  acc=0.8731
  HLA_PEP 评估指标:
  Accuracy:  0.8731
  Precision: 0.8579
  Recall:    0.8944
  F1-Score:  0.8758
  AUC-ROC:   0.9479
  AUC-PR:    0.9428
HLA_PEP PreTrain Epoch 6/10  loss=0.3141  acc=0.8803
  HLA_PEP 评估指标:
  Accuracy:  0.8803
  Precision: 0.8672
  Recall:    0.8981
  F1-Score:  0.8824
  AUC-ROC:   0.9525
  AUC-PR:    0.9477
HLA_PEP PreTrain Epoch 7/10  loss=0.3063  acc=0.8853
  HLA_PEP 评估指标:
  Accuracy:  0.8853
  Precision: 0.8742
  Recall:    0.9002
  F1-Score:  0.8870
  AUC-ROC:   0.9555
  AUC-PR:    0.9507
HLA_PEP PreTrain Epoch 8/10  loss=0.3012  acc=0.8892
  HLA_PEP 评估指标:
  Accuracy:  0.8892
  Precision: 0.8788
  Recall:    0.9028
  F1-Score:  0.8907
  AUC-ROC:   0.9576
  AUC-PR:    0.9527
HLA_PEP PreTrain Epoch 9/10  loss=0.2978  acc=0.8920
  HLA_PEP 评估指标:
  Accuracy:  0.8920
  Precision: 0.8819
  Recall:    0.9053
  F1-Score:  0.8934
  AUC-ROC:   0.9591
  AUC-PR:    0.9541
HLA_PEP PreTrain Epoch 10/10  loss=0.2958  acc=0.8942
  HLA_PEP 评估指标:
  Accuracy:  0.8942
  Precision: 0.8836
  Recall:    0.9080
  F1-Score:  0.8957
  AUC-ROC:   0.9602
  AUC-PR:    0.9551

HLA_PEP 预训练最终指标:
评估指标:
  Accuracy:  0.8677
  Precision: 0.8475
  Recall:    0.8966
  F1-Score:  0.8714
  AUC-ROC:   0.9435
  AUC-PR:    0.9379
=== 第二阶段：TCR-peptide关系预训练 ===
=== 预训练 KGAN（tcr_pep 关系学习） ===
正样本: 811088, 负样本: 811088, 总计: 1622176
TCR_PEP PreTrain Epoch 1/10  loss=0.2509  acc=0.9247
  TCR_PEP 评估指标:
  Accuracy:  0.9247
  Precision: 0.9011
  Recall:    0.9541
  F1-Score:  0.9268
  AUC-ROC:   0.9753
  AUC-PR:    0.9706
TCR_PEP PreTrain Epoch 2/10  loss=0.1952  acc=0.9523
  TCR_PEP 评估指标:
  Accuracy:  0.9523
  Precision: 0.9389
  Recall:    0.9674
  F1-Score:  0.9530
  AUC-ROC:   0.9876
  AUC-PR:    0.9852
TCR_PEP PreTrain Epoch 3/10  loss=0.1775  acc=0.9599
  TCR_PEP 评估指标:
  Accuracy:  0.9599
  Precision: 0.9490
  Recall:    0.9720
  F1-Score:  0.9604
  AUC-ROC:   0.9906
  AUC-PR:    0.9887
TCR_PEP PreTrain Epoch 4/10  loss=0.1685  acc=0.9630
  TCR_PEP 评估指标:
  Accuracy:  0.9630
  Precision: 0.9531
  Recall:    0.9738
  F1-Score:  0.9634
  AUC-ROC:   0.9919
  AUC-PR:    0.9904
TCR_PEP PreTrain Epoch 5/10  loss=0.1625  acc=0.9653
  TCR_PEP 评估指标:
  Accuracy:  0.9653
  Precision: 0.9563
  Recall:    0.9752
  F1-Score:  0.9657
  AUC-ROC:   0.9928
  AUC-PR:    0.9916
TCR_PEP PreTrain Epoch 6/10  loss=0.1581  acc=0.9671
  TCR_PEP 评估指标:
  Accuracy:  0.9671
  Precision: 0.9587
  Recall:    0.9762
  F1-Score:  0.9674
  AUC-ROC:   0.9935
  AUC-PR:    0.9924
TCR_PEP PreTrain Epoch 7/10  loss=0.1539  acc=0.9687
  TCR_PEP 评估指标:
  Accuracy:  0.9687
  Precision: 0.9607
  Recall:    0.9774
  F1-Score:  0.9690
  AUC-ROC:   0.9940
  AUC-PR:    0.9930
TCR_PEP PreTrain Epoch 8/10  loss=0.1491  acc=0.9702
  TCR_PEP 评估指标:
  Accuracy:  0.9702
  Precision: 0.9628
  Recall:    0.9782
  F1-Score:  0.9704
  AUC-ROC:   0.9945
  AUC-PR:    0.9936
TCR_PEP PreTrain Epoch 9/10  loss=0.1462  acc=0.9710
  TCR_PEP 评估指标:
  Accuracy:  0.9710
  Precision: 0.9642
  Recall:    0.9784
  F1-Score:  0.9713
  AUC-ROC:   0.9948
  AUC-PR:    0.9940
TCR_PEP PreTrain Epoch 10/10  loss=0.1435  acc=0.9717
  TCR_PEP 评估指标:
  Accuracy:  0.9717
  Precision: 0.9652
  Recall:    0.9786
  F1-Score:  0.9719
  AUC-ROC:   0.9950
  AUC-PR:    0.9943

TCR_PEP 预训练最终指标:
评估指标:
  Accuracy:  0.9614
  Precision: 0.9508
  Recall:    0.9731
  F1-Score:  0.9618
  AUC-ROC:   0.9917
  AUC-PR:    0.9904
=== 第三阶段：三元组分类训练 ===
=== 训练三元组分类器 (TCR-HLA-肽) ===
正样本: 91945, 负样本: 91945, 总计: 183890
Triple Classifier Epoch 1/10  loss=0.3758  acc=0.8318
  Triple 评估指标:
  Accuracy:  0.8318
  Precision: 0.7725
  Recall:    0.9406
  F1-Score:  0.8483
  AUC-ROC:   0.8881
  AUC-PR:    0.8449
Triple Classifier Epoch 2/10  loss=0.3042  acc=0.8719
  Triple 评估指标:
  Accuracy:  0.8719
  Precision: 0.8018
  Recall:    0.9880
  F1-Score:  0.8852
  AUC-ROC:   0.9196
  AUC-PR:    0.8903
Triple Classifier Epoch 3/10  loss=0.2699  acc=0.8840
  Triple 评估指标:
  Accuracy:  0.8840
  Precision: 0.8296
  Recall:    0.9665
  F1-Score:  0.8928
  AUC-ROC:   0.9435
  AUC-PR:    0.9231
Triple Classifier Epoch 4/10  loss=0.2290  acc=0.9041
  Triple 评估指标:
  Accuracy:  0.9041
  Precision: 0.8705
  Recall:    0.9494
  F1-Score:  0.9082
  AUC-ROC:   0.9620
  AUC-PR:    0.9500
Triple Classifier Epoch 5/10  loss=0.1948  acc=0.9198
  Triple 评估指标:
  Accuracy:  0.9198
  Precision: 0.8955
  Recall:    0.9506
  F1-Score:  0.9222
  AUC-ROC:   0.9735
  AUC-PR:    0.9664
Triple Classifier Epoch 6/10  loss=0.1679  acc=0.9310
  Triple 评估指标:
  Accuracy:  0.9310
  Precision: 0.9122
  Recall:    0.9539
  F1-Score:  0.9326
  AUC-ROC:   0.9808
  AUC-PR:    0.9766
Triple Classifier Epoch 7/10  loss=0.1461  acc=0.9396
  Triple 评估指标:
  Accuracy:  0.9396
  Precision: 0.9249
  Recall:    0.9569
  F1-Score:  0.9406
  AUC-ROC:   0.9856
  AUC-PR:    0.9829
Triple Classifier Epoch 8/10  loss=0.1287  acc=0.9458
  Triple 评估指标:
  Accuracy:  0.9458
  Precision: 0.9335
  Recall:    0.9601
  F1-Score:  0.9466
  AUC-ROC:   0.9890
  AUC-PR:    0.9873
Triple Classifier Epoch 9/10  loss=0.1150  acc=0.9508
  Triple 评估指标:
  Accuracy:  0.9508
  Precision: 0.9410
  Recall:    0.9619
  F1-Score:  0.9514
  AUC-ROC:   0.9913
  AUC-PR:    0.9901
Triple Classifier Epoch 10/10  loss=0.1034  acc=0.9551
  Triple 评估指标:
  Accuracy:  0.9551
  Precision: 0.9469
  Recall:    0.9643
  F1-Score:  0.9555
  AUC-ROC:   0.9931
  AUC-PR:    0.9925

三元组分类器最终指标:
评估指标:
  Accuracy:  0.9134
  Precision: 0.8787
  Recall:    0.9592
  F1-Score:  0.9172
  AUC-ROC:   0.9707
  AUC-PR:    0.9662
=== 第四阶段：TCR生成微调 ===
[DEBUG] 原始微调样本数: 183890
[DEBUG] 过滤后样本数: 91761
训练集大小: 73408
验证集大小: 18353
=== 微调 TCR 生成 ===
[Dataset] 最终样本数: 73408
[Dataset] 词汇表大小: 23
[Dataset] 最大序列长度: 30
数据集大小: 73408
词汇表大小: 23
特殊token: SOS=0, EOS=1, PAD=2
样本0: HLA=437948, PEP=377367, TCR长度=15, TCR=CASSLSIAATAYEYF
样本1: HLA=437970, PEP=576384, TCR长度=13, TCR=CAVNVKGFQKLVF
样本2: HLA=437970, PEP=959006, TCR长度=15, TCR=CAVRPASGGSYIPTF
Epoch 1: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [02:08<00:00, 17.82it/s]
Epoch 1/20  loss=1.6618  ppl=5.27  tokens=1124579
Epoch 2: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [02:04<00:00, 18.48it/s] 
Epoch 2/20  loss=1.5115  ppl=4.53  tokens=1124203
Epoch 3: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [02:04<00:00, 18.37it/s] 
Epoch 3/20  loss=1.4830  ppl=4.41  tokens=1123749
Epoch 4: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [02:03<00:00, 18.56it/s] 
Epoch 4/20  loss=1.4641  ppl=4.32  tokens=1123571
Epoch 5: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [02:01<00:00, 18.95it/s] 
Epoch 5/20  loss=1.4484  ppl=4.26  tokens=1123184
Epoch 6: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [02:01<00:00, 18.89it/s] 
Epoch 6/20  loss=1.4386  ppl=4.21  tokens=1122986
Epoch 7: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [01:59<00:00, 19.13it/s] 
Epoch 7/20  loss=1.4262  ppl=4.16  tokens=1122924
Epoch 8: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [02:04<00:00, 18.47it/s] 
Epoch 8/20  loss=1.4319  ppl=4.19  tokens=1122834
Epoch 9: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [02:02<00:00, 18.75it/s] 
Epoch 9/20  loss=1.4195  ppl=4.13  tokens=1122793
Epoch 10: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [02:03<00:00, 18.60it/s] 
Epoch 10/20  loss=1.4150  ppl=4.12  tokens=1122820
Epoch 11: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [02:00<00:00, 18.98it/s] 
Epoch 11/20  loss=1.4058  ppl=4.08  tokens=1122642
Epoch 12: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [01:58<00:00, 19.38it/s] 
Epoch 12/20  loss=1.3921  ppl=4.02  tokens=1122778
Epoch 13: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [01:55<00:00, 19.79it/s] 
Epoch 13/20  loss=1.3832  ppl=3.99  tokens=1122330
Epoch 14: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [01:54<00:00, 20.06it/s] 
Epoch 14/20  loss=1.3704  ppl=3.94  tokens=1122744
Epoch 15: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [01:55<00:00, 19.84it/s] 
Epoch 15/20  loss=1.3681  ppl=3.93  tokens=1122618
Epoch 16: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [01:58<00:00, 19.32it/s] 
Epoch 16/20  loss=1.3754  ppl=3.96  tokens=1122186
Epoch 17: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [01:56<00:00, 19.76it/s] 
Epoch 17/20  loss=1.3640  ppl=3.91  tokens=1122526
Epoch 18: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [02:02<00:00, 18.73it/s] 
Epoch 18/20  loss=1.3807  ppl=3.98  tokens=1122310
Epoch 19: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [01:58<00:00, 19.40it/s] 
Epoch 19/20  loss=1.3592  ppl=3.89  tokens=1122480
Epoch 20: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 2294/2294 [01:54<00:00, 20.10it/s] 
Epoch 20/20  loss=1.3474  ppl=3.85  tokens=1122470
[Dataset] 最终样本数: 18353
[Dataset] 词汇表大小: 23
[Dataset] 最大序列长度: 30
验证损失: 2.0524, 验证困惑度: 7.79

=== 生成示例（HLA, peptide）→ TCR ===
HLA:HLA-A-03:01  Peptide:KLGGALQAK  =>  TCR:CASSLGGGGGFFFFF
HLA:HLA-B-07:02  Peptide:MPYFFTLLL  =>  TCR:CASSLGGGGGGFFFF
HLA:HLA-A-02:01  Peptide:NLFLFLFAV  =>  TCR:CASSLGGGGGYFFFF
HLA:HLA-A-11:01  Peptide:LVVDFSQFSR  =>  TCR:CASSLGGGGGEEFFFF
HLA:HLA-A-01:01  Peptide:GSHLVEALY  =>  TCR:CASSLGGGGGFFFF
保存完成。